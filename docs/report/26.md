# Denoばた会議 Monthly 第26回
2024年3月1日開催。  
[connpassリンク](https://deno-ja.connpass.com/event/311638/)。

## 今月のアップデートを追う
Denoのアップデートを追っていくLT。  
そのあとの雑談込みでザックリと箇条書き。

[@uki00aさんのスライド](https://uki00a.github.io/slides/denobata-2024-03-01)

### [Deno v1.40](https://deno.com/blog/v1.40)
#### Temporal APIサポート
- `--unstable-temporal`を指定すると、Temporalのサポートが有効化される
- 新しいDatatime API
- カッチリと正しく定義されている印象
- Momentやdate-fnsみたいなお手軽さはない
- 低レベルだけど色んなことができるAPI？
- 差分を取るなど高レベルなこともできるけど、名前つけのクセがJavaっぽい
- TypeScript（補完）があればまだ大丈夫そうだけど、なしだとキツイかも
- Instantはあまり使わないで、ZonedDateTimeを使う感じになりそう
  - InstantだとISOになる

#### `Decorators proposal (stage 3)`のサポート
- 現状は`.ts`などのトランスパイルされるファイルでのみ動作する
- TypeScriptの`experimentalDecorators`を利用したい場合
  - `deno.json(c)`の`compilerOptions.experimentalDecorators`に`true`を設定する
- フレームワークが古いものを使っているので
- recomposeのときにatcomposeと書いていた記憶
- nestjsが多用している記憶
- danet
- alosaurは古いデコレータを使っていたが、移行した（ここが一番早いかも）
- DIしたいときはこの手法だよね
- これで最終仕様になったので、これで安心して使えます

#### Import map expansion
- `msw`配下の`msw/node`のようなサブパスを読み込む挙動の改善
- 今バージョンから、`npm:msw@2.0.8`と`deno.json(c)`の`imports`に記載するだけでサブパスも読み込まれるようになった
  - 以前は`npm:/msw@2.0.8/`と一緒に記載する必要があった
- import mapのそもそもの仕様とは異なる
- ブラウザが解釈できるimport mapとは別の代物になる
- 今までの書き方は特殊で認知度が低いかも
- 利便性は向上した

#### v2に向けた非推奨化
- unstable全体を有効化する`--unstable`が非推奨化
  - `--unstable-*`や`deno.json(c)`の`unstable`オプションに移行推奨
- `window`が非推奨化
  - `globalThis`や`self`に移行推奨
  - 将来的に導入予定の機能を先行体験できる`DENO_FUTURE`環境変数を設定すると削除される
  - 今まではNodeに対応していなかったので、Nodeとブラウザ両方に対応したモジュールはブラウザの分岐に逃がすために存在してた
  - Node互換性に対応したので、今度はこの存在によって
- `Deno.Reader` & `Deno.Writer`
  - 昔からあるReader/Writerのこと
  - やるやるって言ってたのに誰も作業しないから放置されてた
  - アーシャさんという非推奨大好きな人が非推奨化した
    - Deno offsiteのときに来日してDeno社員向けのディナーにもねじ込んできた行動力ある人
  - deno_stdで非推奨をしまくってたけど、ついにやるものがなくなったので
  - そういう作業をしてくれる人が
  - 一時的にはそれで被害を受けたりすることが
- `rid`
  - リソースIDが隠れたような感じで利用できるようになってきたので

#### External WebGPU surfaces / BYOW (Bring your own Window)
- バッファのレンダリングをWebGPUで高速に処理するようなもの？
- Deno自体は画面になにか描画するものは持っていないが、WebGPUは提供している
- ユーザー側で画面とガッチャンコすれば使える感じ
- 以下のモジュールで活用されている
  - [wgui](https://github.com/littledivy/wgui)
  - [deno_sdl2](https://github.com/littledivy/deno_sdl2/commit/41bd7173a1eae1b62ba57dfa6def816b1811abac)
  - [dwm](https://github.com/deno-windowing/dwm/releases/tag/0.3.4)

### [Deno v1.41](https://deno.com/blog/v1.41)
#### パッケージシステム(jsr)関連のアップデート
- [`deno lint`に`no-slow-types`ルールが導入された](https://github.com/denoland/deno/pull/22430)
  - JSRパッケージに対して[`fast check`](https://github.com/denoland/deno_graph/pull/346)を実行してくれる
  - 明示的に戻り値やシグネチャの型定義の省略を検知して知らせる
- `deno publish`で型チェックが自動実行がサポート

#### `deno compile`で`denort`バイナリが再導入
- かつて[削除された](https://github.com/denoland/deno/pull/10350)が、再導入された
- `deno compile`によって生成される実行可能ファイルのサイズが大きく削減されている
- かつては`deno compile --lite`
- deno fmtなどを消して必要なランタイムだけ抜き出したのがdenortだった
- これの管理が大変だった
- 今回、denortが再導入されて小さいバイナリが作れるようになった
- デフォルトでdenortでコンパイルされる
- 全部入りは環境変数でバイナリのパスを指定すると全部入りもできる
- あまり推奨されていなさそう
- モチベーション
- 少し前に必要なものだけ残したカスタムのバイナリを用意する予定と言っていたので、それで新たに入ったのかな？
- 知らないところで色々動いてるな……
- deno-lambdaの強化もあったので、それも関連してるかも
- lambdaはバイナリサイズが起動時間の長さに関わってくるので、そこを縮めたかった狙いがあるかも
- lambdaはそれで専用のランタイム（LLRT）やってるし
- エンジンがQuickJSで、すごく小さい
- 起動がメチャクチャ早い
- 量をさばくタイプではなく起動が早いことを重視
- 広い意味ではLLRTとやりあう感じになるが、V8を使っている時点で張り合えないので、node-lambdaよりは早く動きたいねという感じ
- LLRTはサイズが小さすぎるし、向いている方向性が違うので
- 起動後はリクエスト数が多ければJITがあるV8に軍配が上がるのでは

#### `process.env`の挙動の変更
- `--allow-env`で指定されていない`process.env`の環境変数があれば、パーミッションプロンプトが表示される
- 許可ないものとして挙動していたので、変な挙動していた
- chalkとかprocess.envの許可なし挙動の影響で、「この環境は色がつけられない！」という挙動になっていた
  - chalkをnode互換性で動かそうとしたら

### その他の話題
#### JSR
- [waitlistが公開された](https://jsr.io/waitlist)
- deno-postgresは[すでに公開されている](https://github.com/denodrivers/postgres/pull/453)
- [GitHub Organization](https://github.com/jsr-io)も公開されている
- `deno.land/x`のモジュールをJSRパッケージに変換する[`@deno/x-to-jsr`](https://github.com/denoland/x-to-jsr)もJSRに公開済み
- 今はwaitlistない
- JSRのリリース日が今日
- オランダでDev world（日本で言うデブサミ）のような大規模イベントがあり、日本時間9時半にRyanさんがJSRについて話し、正式公開をアナウンスする
- 今後は、deno.land/x/postgresからjsr:@bartlomieju/postgresに主流が移っていくだろう
- npmにもJSR CLIがリリース済み
- 移行ツールで
- 2文字の人とかいて微妙な感じ
- Scopeは3つしか取れないけど、その配下にはいくらでも登録できる
- GoogleとかAWSとかは予約されていて、第三者が登録しないようにしている
- googleが登録されているけど、正しい人に渡っているか不明
- Scopeのみがトップレベルは審査制にしようか検討中
- トップレベルは素性がわかっているものという感じにしたい

#### Hono v4がリリース
- マルチランタイムのOSS
- JavaScriptが主軸ではないYAPCのトップバッターでのリリースがトップバッターだったの面白い
- [SSGサポート](https://deno.land/x/hono@v4.0.8/adapter/deno/index.ts?s=toSSG)
- Client Coomponents ([hono/jsx/dom](https://github.com/honojs/hono/pull/1917))
  - ReactのようなuseStateなどの実装
  - 実装としては自前
  - 実装者いわく、Reactは見てないらしい
- [HonoX](https://github.com/honojs/honox)
  - Expressの立ち位置からNext.jsの立ち位置になった
- yuskebeさんはMojoliciousに携わっていたのでExpress的なレイヤーには詳しく、そのレイヤーでのHonoの立ち位置を考えていた
- 今後、Next.js的な立ち位置で大規模な採用をされたときの対応とか、そういうのが求められたときにどうなるのか気になる
- Denoもバンドラやり始めるとユーザーの要望を拾いきれずにバタバタするのでやらなかったり、やることの選択をしている

#### [LumeCMSがリリース](https://lume.land/blog/posts/lume-cms/)
- コンテンツのプレビューや編集などがサポート
- HonoやDeno KVなどが使われている
- アダプターを作ればLume以外でも利用できるらしい
- オープンなものでセルフホスティングするタイプ
- 将来的にサービス化するのかも？
- CMS SaaSはレッドオーシャンなので、どうなるのかな？

#### [Denoハンズオン＆もくもく会：Fresh + KV](https://deno-ja.connpass.com/event/311182/)
- 2024年3月2日に開催
  - なのでレポートが出てる頃には終わってます
- 枠いっぱいになってるので、希望者いれば枠増やすとか管理者が枠から抜けたりして対応しますのでお気軽にどうぞ
- 以下の3つをハンズオン
  - Fresh + Deno Deployで簡単なWebサイトをPublishしてみよう
  - Deno KVを使ってWebサービスを作ってみよう
  - Freshのislandアーキテクチャって何？
- もくもく会も併設

#### Denoのリリースサイクルの話
- いつの間にか6週間になっていたが、また4週間に戻った

## 質問共有コーナー
### はじめさんのDeno利用例について
出てちょっとしたときにローカルでスクリプトを動かしていたくらい
努めている会社のプロダクトに突っ込んでいる
スクリプトとして突っ込んでいる
Node Workspace
サーバーで動かすコードは入っていない
フロントエンドやユーティリティが入っている
その中にあるローカルでシュッと動かしたいツール群が入っている
Not a Hotelさんと同じような使い方
  サーバーはクラウドフレア、ツール系はDenoだった
Denoはoptionsをエクステンドとかする必要がないので省設定できる、fmtがある
Vitestで書いていたのをDeno.testに書き換えたりしている
Node.jsのESM移行は終わっていて、Jestだと厳しかったのでVitestにしていたが、そこから更に部分的に移行していた
サードパーティモジュールへの依存が減らせてシュッとかけるようになった

つらいことある？
者レポ構成でdeno.jsonとpackage.jsonが同居していると、LSPが少し歯痒い感じがある
プロジェクトルートにimport_map.jsonを置いて、.vscode/config.jsonでそれを読むようにして、それをdeno.jsonで読むようにしている

Denoチーム自身はNodeとDenoの混在をあまりできていないので、そういう知見はありがたい
Tips集を書いていただけるとありがたい

Workspaceについての実装が一旦追加されて削除された？
Workspaceは内部的にはやりましょうになってる
deno_stdはワークスペースで動いてるので、実行自体はされている
公式のリリースはされていないかも
みんなが思うWorkspeceになるかはデイビットさんのさじ加減次第
デイビットさんはDeno fmtを作ってる人


### bIdというIMEユーザー辞書統一出力ツールを作りました

### Fresh Gardenというログイン機能を生やすものを作った
- Deno Deployでは超限定的な状況でしか動的インポートができない
- 超限定的な動的インポートを再現する方法を導入時に案内している
- Deno Deployのダイナミックインポート
- 静的なインポートをするとバンドルに含まれるので、動的インポートが効く
- 毎週月曜0時に最新のFreshを入れて動作するかテストしている
- ユーザー認証をするサーバーがほしいので、テストのときにDockerを立てている
- 他の方の参考になれば

## 参考資料
上記をまとめる際に眺め、かつ箇条書きの中に含められなかった資料です。  
名前だけ掠ってて関係ない資料もあるかと思いますが、まとめる作業の可視化として残しています。  
読まなくて大丈夫です。

- [example](https://example.com/)
