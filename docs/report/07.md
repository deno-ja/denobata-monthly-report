# Denoばた会議 Monthly 第7回
2022年3月20日開催。  
[connpassリンク](https://deno-ja.connpass.com/event/240316/)。

## 今月のアップデートを追う
Denoのアップデートを追っていくLT。  
Discord上の会話はザックリと箇条書き。

[@uki00aさんのスライド](https://uki00a.github.io/slides/denobata-2022-03-20)

### [Deno v1.20](https://deno.com/blog/v1.20)
#### `permissions`オプションの挙動が変更（破壊的変更）
`Deno.test`の`permissions`で明示されていないものはデフォルトで無効化されておらず、直感的ではなかったのでデフォルト無効化に変更された。

#### `deno task`コマンド
deno.jsonに以下のように定義することで、`deno task start`のようなコマンドを実行可能になる
``` json
{
  "tasks": {
    "start": "deno run --allow-net mod.ts"
  }
}
```

#### `deno bench`コマンド
`Deno.bench`の内部に関数を書き、`deno bench --unstable`と書くことで、コードのベンチマークを取得できる。

``` typescript
Deno.bench("URL parsing", () => {
  new URL("https://deno.land");
});
```

#### HTTPレスポンスの自動圧縮
以下の条件を満たす場合、DenoのネイティブHTTPサーバー（`std@0.130.0/http/server.ts`の`serve`など）がHTTPレスポンスを自動圧縮するようになった。

- クライアントリクエストがgzipまたはbrotli圧縮のいずれかをサポート
- 圧縮可能なContent-Typeであること
- レスポンスが20バイト以上

圧縮後は、[`Content-Encoding`ヘッダー](https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Content-Encoding)を設定してエンコーディングを反映、[`Vary`ヘッダー](https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Vary)を調整しレスポンスに影響を与えたリクエストヘッダを追加する。

#### `deno test --trace-ops`
`Deno.test`でリソースリーク検出時のエラー内容が改善される。

#### `Deno.connect`のAPIが変更
今までは`Deno.Conn`というオブジェクトを返していたが、`transport: "tcp"`を指定すると`Deno.TcpConn`、`transport: "unix"`を指定すると`Deno.UnixConn`が返ってくるようになる。  
Deno.Connに定義されていた`setNoDelay()`や`setKeepAlive()`は`Deno.TcpConn`に移動している。

#### `Deno.listenTls`で`cert`と`key`オプションがサポート
元々存在していた`certFile`と`keyFile`は非推奨化。

#### パフォーマンス改善
Op（という命令単位）の呼び出しが最大で60%程度まで高速化。また、`atob`/`btoa`も最大20倍ほどの改善がされている。

#### TypeScriptが`v4.5.2`から`v4.6.2`へアップデート
[タグ付きユニオンがさらに進化する](https://zenn.dev/uhyo/articles/ts-4-6-destructing-unions)などの更新内容が含まれている。  
詳細は[公式ブログ投稿](https://devblogs.microsoft.com/typescript/announcing-typescript-4-6/)を参照。

#### deno.json(c)でimportMapオプションがサポート

#### `Deno.upgradeHttp()`が追加

#### `AbortSignal.timeout()`が実装

### deno_std
#### Web Streams APIへの段階的移行
多くのdeno_stdが`Deno.Writer`/`Deno.Reader`といったGoスタイルで実施されていたが、それらを徐々にWeb Streams APIに移行していく。  
進捗は以下Issueにまとめられている。  
https://github.com/denoland/deno_std/issues/1986

uki00aさんも[`encoding/csv`の移行作業](https://github.com/denoland/deno_std/pull/1993)に携わっている。

#### `dotenv`モジュールが追加

#### `deno_std/node`の改善
[node-mysql2](https://github.com/sidorares/node-mysql2)パッケージがある程度動くようになった模様。  
deno_stdのリポジトリに[example](https://github.com/denoland/deno_std/blob/0.130.0/node/integrationtest/mysql2-example.js)がある。

### [deno.landがNode.jsからDenoへ移行](https://github.com/denoland/dotland/pull/2016)
Next.js/TailwindCSS/VercelからFresh/Twind/Deno Deployに移行。

### [FreshでIsland architectureが実装](https://github.com/lucacasonato/fresh/pull/97)

Freshが、部分的ハイドレーションでWebサイトを構築するIsland architectureで実装された。  
それに伴い、ディレクトリ構造の見直しや`useData()`や`<Suspence>`などの削除も行われた。`<Suspence>`は再度追加予定とのこと。

### Remix v1.2.0での実験的なDenoサポート
Remix v1.2.0から、以下コマンドでDenoのテンプレートが構築される。

``` bash
yarn create remix --template deno-ts
```

### oakのNode.jsサポート
dntを利用してoakがNode.jsをサポート。[`@oakserver/oak`](https://www.npmjs.com/package/@oakserver/oak)という名称でnpmにパブリッシュされている。  
現在は10.3.0と10.4.0、10.5.0がリリース済み。

Deno公式ブログに[解説記事](https://deno.com/blog/dnt-oak)が公開されている。

## 参考資料
上記をまとめる際に眺め、かつ上記の中に含められなかった資料です。  
名前だけ掠ってて関係ない資料もあるかと思いますが、まとめる作業の可視化として残しています。  
読まなくて大丈夫です。

- [Accept-Encoding - HTTP | MDN](https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Accept-Encoding)
- [HTTP Server APIs | Manual | Deno](https://deno.land/manual@v1.20.1/runtime/http_server_apis#automatic-body-compression)
- [deno::Op - Rust](https://docs.rs/deno/0.3.10/deno/type.Op.html)
- [denosaurs/deno_json_op: 📋 A macro for easing the development of deno plugins](https://github.com/denosaurs/deno_json_op)
- [Partial Hydration in Astro 🚀 Astro Documentation](https://docs.astro.build/en/core-concepts/component-hydration/#concept-island-architecture)
- [Islands Architecture - JASON Format](https://jasonformat.com/islands-architecture/)
- [Architecture | fresh docs](https://fresh.deno.dev/docs/concepts/architechture)
- [lucacasonato/fresh: Preact, but super edgy](https://github.com/lucacasonato/fresh/)
